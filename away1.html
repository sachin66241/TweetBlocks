<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="refresh">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eosjs@16.0.0/lib/eos.min.js"></script>
    <script src="dist/scatter.min.js"></script> 
    <script src="main.js"></script>
    <link rel="stylesheet" href="away.css">
    <title>Profile</title>
</head>
<body>
        <button onclick="signOut()">SIGN OUT</button>
        <button id="buttonFollow"></button>
        <button id="buttonFollowers">Followers</button>
        <button id="buttonFollowing">Following</button>
        

        <!-- <button onclick="unfollow()">UNFOLLOW</button> -->
        <h1>your search result contains......!!!!!!</h1>
        <p id="don"></p>
        <p id="ron"></p>
        <p id="mon"></p>
        <p id="jon"></p>
        <p id="zon"></p>
    
        <p id="den"></p>


        <div id="myModal" class="modal">

                <!-- Modal content -->
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <div id="rplContent">
                      
                  </div>
                </div>
              
        </div>

        <script>
                // Get the modal
                var modal = document.getElementById('myModal');
                
                // Get the button that opens the modal
                var btn = document.getElementById("myBtn");
                
                // Get the <span> element that closes the modal
                var span = document.getElementsByClassName("close")[0];
                
                // When the user clicks the button, open the modal 
                // btn.onclick = function() {
                //     modal.style.display = "block";
                // }
                
                // When the user clicks on <span> (x), close the modal
                span.onclick = function() {
                    modal.style.display = "none";
                }
                
                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                }
                </script>
              

    <script>



function globalfn(){
    var tweeeets;
    var length;
    var mainAcc;
    
 }

globalfn();
main();

        // //////////////////////////////
   var parameters = location.href.split("#")[1];
  // console.log(parameters);
  // $('#buttonFollowers').badge.text=accFollowers.length;

   function follow(){
        
    
             const account = scatter.identity.accounts.find(account => account.blockchain === 'eos');
            const options = {
                     authorization: [ `${account.name}@${account.authority}`]
                      };
    
        
    
            var eos = scatter.eos(network, Eos, options);
    
            
                scatter.getIdentity({accounts:[network]}).then(function(id){
                    const account = id.accounts.find(function(x){ return x.blockchain === 'eos' });
                   // console.log('acc', account);

    
                    eos.contract('twitternew12').then(contract => {
                        var accName = id.accounts[0].name
                        var following=parameters;
                      //  console.log(following);
                       // console.log(accName);

                        contract.follow({accName,following},options).then(function(res){
                            console.log('res', res);
                            main();
                        }).catch(function(err){
                            console.log('err', err);
                        });
                    });

                })
        
              
       }


        function unfollow(){
        
    
             const account = scatter.identity.accounts.find(account => account.blockchain === 'eos');
            const options = {
                     authorization: [ `${account.name}@${account.authority}`]
                      };
    
        
    
            var eos = scatter.eos(network, Eos, options);
    
            
                scatter.getIdentity({accounts:[network]}).then(function(id){
                    const account = id.accounts.find(function(x){ return x.blockchain === 'eos' });
         //           console.log('acc', account);

    
                    eos.contract('twitternew12').then(contract => {
                        var accName = id.accounts[0].name
                        var unfollowing=parameters;
                     //   console.log(unfollowing);
                      //  console.log(accName);

                        contract.unfollow({accName,unfollowing},options).then(function(res){
                            console.log('res', res);
                            main();
                        }).catch(function(err){
                            console.log('err', err);
                        });
                    });

                })
        
               
       }


        function like(twId){
        
    
        const account = scatter.identity.accounts.find(account => account.blockchain === 'eos');
       const options = {
                authorization: [ `${account.name}@${account.authority}`]
                 };

   

       var eos = scatter.eos(network, Eos, options);

       
           scatter.getIdentity({accounts:[network]}).then(function(id){
               const account = id.accounts.find(function(x){ return x.blockchain === 'eos' });
           //    console.log('acc', account);


               eos.contract('twitternew12').then(contract => {
                   var accName = id.accounts[0].name
               //    console.log(accName);

                   contract.like({accName,tweetId:twId},options).then(function(res){
                       console.log('res', res);
                       main();
                   }).catch(function(err){
                       console.log('err', err);
                   });
               });

           })
   

  }

      function unlike(twId){
        
    
        const account = scatter.identity.accounts.find(account => account.blockchain === 'eos');
       const options = {
                authorization: [ `${account.name}@${account.authority}`]
                 };

   

       var eos = scatter.eos(network, Eos, options);

       
           scatter.getIdentity({accounts:[network]}).then(function(id){
               const account = id.accounts.find(function(x){ return x.blockchain === 'eos' });
          //     console.log('acc', account);


               eos.contract('twitternew12').then(contract => {
                   var accName = id.accounts[0].name
                 //  console.log(accName);

                   contract.unlike({accName,tweetId:twId},options).then(function(res){
                       console.log('res', res);
                       main();
                   }).catch(function(err){
                       console.log('err', err);
                   });
               });

           })
   

  }


  function following(){

                
                var followDiv=document.createElement("div");
                document.getElementById("rplContent").innerHTML="";
                 document.getElementById("rplContent").appendChild(followDiv);
                 followDiv.innerHTML=accFollowing;
                // $('#rplContent').html(bal.rows[0].reply);
                 modal.style.display = "block";
                 


  }

  function followers(){

                var followDiv=document.createElement("div");
                document.getElementById("rplContent").innerHTML="";
                 document.getElementById("rplContent").appendChild(followDiv);
                 followDiv.innerHTML=accFollowers;
                // $('#rplContent').html(bal.rows[0].reply);
                 modal.style.display = "block";
               //  console.log(accFollowers);
                


  }
 
   /////////////////////////////////////////////////////////////////////////////////

function main(){

  scatter.connect("TestPage").then(function(connected){
 // console.log('connected', connected);


        network = {
            protocol:'http', 
            blockchain:'eos',
            host:'52.199.125.75',
            port:8888,
            chainId:"038f4b0fc8ff18a4f0842a8f0564611f6e96e8535901dd45e43ac8691a1c4dca",
            };
            const requiredFields = {
            personal:['firstname','lastname'],
            accounts:[network]
            
            };
            var hell="";
                   scatter.getIdentity(requiredFields).then(function(id){
                    account = id.accounts.find(function(x){ return x.blockchain === 'eos' });
                    const options = {
                 authorization: [ `${account.name}@${account.authority}`]
                  };

                   var eos = scatter.eos(network, Eos, options);
              //      console.log('acc', account);
                    mainAcc=id.accounts[0].name;
                    hell=parameters;
                   // console.log(hell);
                    var data = JSON.stringify({
                        "scope": hell,
                        "code": "twitternew12",
                        "table": "account",
                        "json": "true"
                    });

        var xhr = new XMLHttpRequest();
        xhr.withCredentials = false;

        xhr.addEventListener("readystatechange", function () {
                if (this.readyState === this.DONE) {
        var bal = JSON.parse(this.responseText);
        //console.log(bal);

                    var foll=0;
                    accFollowers=[];                    
                    while(foll<bal.rows[0].followers.length){
                    //var countries = bal.rows[val].accName;
                    accFollowers.push(bal.rows[0].followers[foll]);
                    foll++
                    }

                    var follo=0;
                    accFollowing=[];                    
                    while(foll<bal.rows[0].following.length){
                    //var countries = bal.rows[val].accName;
                    accFollowing.push(bal.rows[0].following[follo]);
                    follo++
                    }
                    if(accFollowers.length>0){
                    document.getElementById('buttonFollowers').setAttribute('onclick','followers()');
                    }
                    if(accFollowing.length>0){
                    document.getElementById('buttonFollowing').setAttribute('onclick','following()');
                    }
                    //console.log("Likes:" + likedUsers.length);
                    //console.log(likedUsers);
                    
                    if(accFollowers.includes(mainAcc)){

                       $('#buttonFollow').html("UNFOLLOW")
                      document.getElementById('buttonFollow').setAttribute('onclick','unfollow()');
                    
                    }
                    
                    else{
                        
                       $('#buttonFollow').html("FOLLOW")
                       document.getElementById('buttonFollow').setAttribute('onclick','follow()');
                    
                    
                    }
        
        $("#don").text("His account name : " + bal.rows[0].accName);
        $("#ron").text("username : " + bal.rows[0].userName);
        $("#mon").text("No. of tweets : " + bal.rows[0].tweetId.length);

        $("#jon").text("No. of followers : " + bal.rows[0].followers.length);
        $("#zon").text("No. of following : " + bal.rows[0].following.length);
        length=bal.rows[0].tweetId.length;


     
        // console.log(bal);
        
        //   eos.getTableRows(true, tweetId, "twitter4eos1", "tweettable").then(function(a){
        //   console.log(a);
        //   })
        var tweetCount=(bal.rows[0].tweetId.length);





                    if(tweetCount>0){
          
                           tweets(bal.rows[0].tweetId);

                          }

                    else{

                           console.log("No Tweets Yet !!!!");

                          }   
    }
});
xhr.open("POST", "http://52.199.125.75:8888/v1/chain/get_table_rows");
xhr.send(data);

})

}).catch(function(x){
  console.log('x', x);
});

}

iDiv = document.createElement('div');

function tweets(tweetIndex){
          
         
          
          
          iDiv.innerHTML="..........................TWEETS MADE BY THIS PERSON..........................";
        
          for (var index = 0; index < tweetIndex.length; index++) {
        
            //console.log(tweetIndex);
            var data = JSON.stringify({
              "scope": tweetIndex[index],
              "code": "twitternew12",
              "table": "tweettable",
              "limit": 50,
              "json": "true"
            });
          
          
          var xhr = new XMLHttpRequest();
          xhr.withCredentials = false;
          
          xhr.addEventListener("readystatechange", function () {
                if (this.readyState === this.DONE) {
                  var bal = JSON.parse(this.responseText);
                  tweeeets = bal;
                  //console.log(tweeeets);
                  //console.log(length);
               
                   
                 
                    var idiv1 = document.createElement('div');
                    var idiv2 = document.createElement('div');
                    var idiv3 = document.createElement('div');

                    
            
                 
                    // button.innerHTML= "Comment";
                    var input = document.createElement('textarea');
                    var button = document.createElement('button');
                    var replyButton = document.createElement('button');
                    
                    var likeButton = document.createElement('button');
                   // like.innerHTML = "";
                   
                    replyButton.innerHTML = "replies"
                    button.innerHTML = "Comment";
                    replyButton.id = "button"+bal.rows[0].tweetId;
                    input.id='comment'+bal.rows[0].tweetId;
                    input.name = "post";
                    //console.log(bal.rows[0].tweetId);
                    input.maxLength = "100";

                    input.cols = "20";
                    input.rows = "3";

                    val=0;
                    var likedUsers=[];                    
                    while(val<tweeeets.rows[0].likes.length){
                    //var countries = bal.rows[val].accName;
                    likedUsers.push(bal.rows[0].likes[val]);
                    val++
                    }
                    //console.log("Likes:" + likedUsers.length);
                    //console.log(likedUsers);
                    
                    if(likedUsers.includes(mainAcc)){

                        likeButton.innerHTML="unlike";
                        likeButton.setAttribute('onclick','unlike('+bal.rows[0].tweetId+')');
                    
                    }
                    
                    else{
                        
                        likeButton.innerHTML="like";
                        likeButton.setAttribute('onclick','like('+bal.rows[0].tweetId+')');
                    
                    
                    }
                




                    
                   var xxx = input.value;
                   //console.log(input.id);
                   //console.log(bal.rows[0].replies+"ssssS");

                  // var replies=bal.rows[0].replies;
                  replies=bal.rows[0].replies;
                  //tweeeets = bal.rows[0];
                  if(replies.length>0){
                    
                    // console.log(replies);
                    // console.log(bal.rows[0].tweetId);
                    //replie(bal.rows[0].tweetId,replies);
                    replyButton.setAttribute('onclick','replie('+bal.rows[0].tweetId+')');
                 
                    }
                
                   button.setAttribute('onclick', 'comment('+bal.rows[0].tweetId+')');
                   // document.body.appendChild(idiv3);
                    

                    //iDiv.id = 'block';
                    //iDiv.className = 'block';
                    
                    idiv1.innerHTML = bal.rows[0].msg;
                    idiv2.innerHTML= convert(bal.rows[0].timestamp);
                    //idiv3.innerHTML=bal.rows[0].tweetId;
                   // idiv3.id = "idField"+bal.rows[0].tweetId;
                    
                    iDiv.appendChild(idiv1);
                    iDiv.appendChild(idiv2);
                    iDiv.appendChild(idiv3);
                    
                    iDiv.appendChild(input);
                    iDiv.appendChild(button);
                    iDiv.appendChild(replyButton);
                    iDiv.appendChild(likeButton);
                   // iDiv.appendChild(bText);
                    document.getElementsByTagName('body')[0].appendChild(iDiv);
                    

}
            });
            xhr.open("POST", "http://52.199.125.75:8888/v1/chain/get_table_rows");
            xhr.send(data);
        }
    }









function replie(twId){

 var data = JSON.stringify({
              "scope": twId,
              "code": "twitternew12",
              "table": "tweettable",
              "limit": 50,
              "json": "true"
            });
          
          
          var xhr = new XMLHttpRequest();
          xhr.withCredentials = false;
          
          xhr.addEventListener("readystatechange", function () {
                if (this.readyState === this.DONE) {
                  var bal = JSON.parse(this.responseText);
                  for (let index = 0; index < bal.rows[0].replies.length; index++) {
                      reply(bal.rows[0].replies[index]);
                      
                  }


                  }
            });
            xhr.open("POST", "http://52.199.125.75:8888/v1/chain/get_table_rows");
            xhr.send(data);


        }



   function reply(replyIndex){


    //var idivReply = document.createElement('textarea');
    //replyButton.appendChild(idivReply);
   // var input = document.createElement('textarea');
    //console.log(replyIndex);

    document.getElementById("rplContent").innerHTML="";
            var data = JSON.stringify({
              "scope": replyIndex,
              "code": "twitternew12",
              "table": "replytable",
              "limit": 50,
              "json": "true"
            });
          
                  
          var xhr = new XMLHttpRequest();
          xhr.withCredentials = false;
          
          xhr.addEventListener("readystatechange", function () {
                if (this.readyState === this.DONE) {
                  var bal = JSON.parse(this.responseText);
                  //console.log(bal);
                
                 var time=convert(bal.rows[0].timestamp);
                 var accName=bal.rows[0].accName;
                 var rply=bal.rows[0].reply;
                 var result=accName +" : "+rply+"   "+time;
                  
                 //console.log(bal.rows[0].reply);
                 var rplyDiv=document.createElement("div");
                 document.getElementById("rplContent").appendChild(rplyDiv);
                 rplyDiv.innerHTML=result;
                // $('#rplContent').html(bal.rows[0].reply);
                 modal.style.display = "block";
                // console.log(tweeeets);
                  


               
}
            });
            xhr.open("POST", "http://52.199.125.75:8888/v1/chain/get_table_rows");
            xhr.send(data);

   }






 </script>
    
</body>
</html>