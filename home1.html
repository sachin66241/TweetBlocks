<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- <script src="js/autocomplete.js"></script> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eosjs@16.0.0/lib/eos.min.js"></script>
  <script src="dist/scatter.min.js"></script> 
  <!-- <script src="index.js"></script> -->
  <script src="autopredict.js"></script>
  <script src="main1.js"></script>
  <title>Home</title>
  <style>
    body {font-family: Arial, Helvetica, sans-serif;}
            
    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 500px; /* Full width */
        height: 300px; /* Full height */
        overflow: scroll; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    
    /* Modal Content */
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    
    /* The Close Button */
    .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    
    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }</style>
</head>
<body>
  
    

  <button onclick="signOut()">SIGN OUT</button>
  <input type="button" value="PROFILE" onclick="men()">
  <!-- <button onclick="check()">check</button> -->
  <form name="F3">
    <h1 id="userName"></h1>
    <h2 id="demo"></h2> 
    <h2 id="demo1"></h2>  
    <form autocomplete="off" action="/action_page.php"  >
      <div class="autocomplete" style="width:300px;">
        <input id="searchField" type="text" placeholder="username">
        <input type="button"  value="Find" onclick="searchUser()">
      </div>
    </form>
    <div>
      <br>
      <textarea id="tweetMsg" cols="30" rows="4" placeholder="write here..........!!!!"></textarea><br>
      <input type="button" value="TWEET" onclick="tweet()"> 
    </div>
    <!-- <a href="accountinfo.html"><input type="button" value="PROFILE"></a> -->
     
  </form>
  <br><br>
  <div id="allTweets">

  </div>



  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="rplContent">
          
      </div>
    </div>
  
</div>

<script>
    // Get the modal
    var modal = document.getElementById('myModal');
    
    // Get the button that opens the modal
    var btn = document.getElementById("myBtn");
    
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];
    
    // When the user clicks the button, open the modal 
    // btn.onclick = function() {
    //     modal.style.display = "block";
    // }
    
    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    </script>




  <script>
    "use strict";

    $("#searchField").val("");
    var allUsers = [];
    var users = [];
    connect().then(function(res){
      getTable(account.name, "account").then(function(res){
        $("#userName").text(res.rows[0].userName);
        main();
        getTable("twitternew12", "users").then(function(res){
        for(var i = 0;i < res.rows.length;i++) {
        userslist.push(res.rows[i]);
    }
  });
      });
      
      getTable("twitternew12", "users").then(function(res){
        for(var i = 0;i < res.rows.length;i++) {
           allUsers.push(res.rows[i]);
           users.push(res.rows[i].userName);
        }
      });
      autocomplete(document.getElementById("searchField"), users);
    });

    function getAccount(accName){
      eos.getTableRows(true, "twitternew12", accName, "").then(function(res){
        console.log(res);
      });
    }

    function tweet(){
      scatter.getIdentity({accounts:[network]}).then(function(id){
        eos.contract('twitternew12').then(contract => {
          var tweetId = Math.floor((Math.random() * 100000) + 1);
          var accName = account.name;
          var msg = $("#tweetMsg").val();
          var timestamp =  Date.now();
          contract.tweet({tweetId,accName,msg,timestamp},options).then(function(res){
            console.log('res', res);
            main();
          }).catch(function(err){
            console.log('err', err);
          });
        });
      }).catch(function(x){});
    }

   // var dict=[];
   
    function getTweet(tweetId){
      getTable(tweetId,"tweettable").then(function(result){

          dict.push({
            key:   tweetId,
            value: result.rows[0].timestamp
        });
        
     // console.log(dict);
        var tweet = result.rows[0];
        var tweetDiv = document.createElement('div');
        var msgDiv = document.createElement('div');
        var likeBtn = document.createElement('button');
        likeBtn.innerHTML = 'Like';
        var n = tweet.accName + " -> " +tweet.msg;
        msgDiv.innerHTML =n;
        document.getElementById('allTweets').appendChild(tweetDiv);
        tweetDiv.appendChild(msgDiv);
        tweetDiv.appendChild(likeBtn);
      });
      console.log(dict);
      console.log(dict.length);
    }
    
   
    function getAccount(accName){
      
    }

    function searchUser() {
      var acc = allUsers.find(function(x){ return x.userName === $("#searchField").val() });
      var url = 'http://127.0.0.1:5500/away.html#' + acc.accName;
      window.location.href = url;
    }
    function men(){
      var url = 'http://127.0.0.1:5500/away.html#' + account.name;
      window.location.href = url;

    }

var mainFollowing=[];

var tweetIds=[];



function main(){

   
    getTable(account.name, "account").then(function(run){

                  var val=0;
                  mainFollowing=[account.name];                    
                  while(val<run.rows[0].following.length){
                        
                    mainFollowing.push(run.rows[0].following[val]);
                    val++
                }
                
                followingTweet(mainFollowing); 
                console.log(mainFollowing);   
            });
         } 
         
         
var dict = [];
var arr=[];
  
function followingTweet(mainFollowing){
          var i;
          var m=mainFollowing.length;

        for( i=0;i<m;i++){

            getTable(mainFollowing[i], "account").then(function(run){

                        var j;
                        var r=run.rows[0].tweetId.length;
               
                        for(j = 0;j < r;j++){
                            getTable(run.rows[0].tweetId[j], "tweettable").then(function(res){
                               // console.log(res.rows[0].tweetId);
                               dict.push(res.rows[0].tweetId);
                               arr.push(parseInt(res.rows[0].timestamp));  
                                
                               // console.log(dict.length);
                            });
                           
                        }
                            
                  });
                    
              }
          }


     function sorting(){
         
         console.log(dict);
         console.log(arr);
         var a;
         var l=arr.length;
         var c,temp,temp1;
         for( a=0;a<l;a++){
         for( c=l-1;c>0;c--){
 
            if (arr[c]<arr[c-1]){
              temp=dict[c-1];
              dict[c-1]=dict[c];
              dict[c]=temp;
              temp1=arr[c-1];
              arr[c-1]=arr[c];
              arr[c]=temp1;
 
            }
 
         }
       }
 
      tweets(dict);
 
   } 
   
   

          
  setTimeout(function(){sorting()}, 4000);       
       
        

  </script>
</body>
</html>