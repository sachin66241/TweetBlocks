<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- <script src="js/autocomplete.js"></script> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eosjs@16.0.0/lib/eos.min.js"></script>
  <script src="js/scatter.min.js"></script> 
  <script src="js/autopredict.js"></script>
  <script src="js/main.js"></script>
  <title>Home</title>
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <button onclick="signOut()">SIGN OUT</button>
  <button onclick="visitProfile()">PROFILE</button>
  <form name="F3">
    <h1 id="userName"></h1>
    <h2 id="demo"></h2> 
    <h2 id="demo1"></h2>  
    <form autocomplete="off">
      <div class="autocomplete" style="width:300px;">
        <input id="searchField"  cols="30" rows="4"  type="text" placeholder="Search username">
        <input type="button" id="searchBtn"  value="Find" onclick="searchUser()">
      </div>
    </form>
    <div>
      <br>
      <textarea id="tweetMsg" cols="30" rows="4" placeholder="write here!!!"></textarea><br>
      <input type="button"  value="TWEET" onclick="tweet()"> 
    </div>     
  </form>
  <br><br>
  <div id="allTweetDiv">
    <h1 style="text-align: center;">Recent tweets</h1>
    <div id="loader" class="spinner">
      <div class="rect1"></div>
      <div class="rect2"></div>
      <div class="rect3"></div>
      <div class="rect4"></div>
      <div class="rect5"></div>
    </div>
  </div>

  <button id="myBtn" style="display:none">Open Modal</button>
  
<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header">
        <span class="close">&times;</span>
      <h2 id="tweetInrply"></h2>
    </div>
    <div class="modal-body">
      <p id="rplContent"></p>
      
    </div>
    <div class="modal-footer">
      <h3></h3>
    </div>
  </div>

</div>

<script>
// Get the modal
var modal = document.getElementById('myModal');

// Get the button that opens the modal
var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
btn.onclick = function() {
    modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}


var input = document.getElementById("searchField");
input.addEventListener("keyup", function(event) {
    event.preventDefault();
    if (event.keyCode === 13) {
        document.getElementById("searchBtn").click();
    }
});
  </script>

  <script>

 
    "use strict";

    //$("#searchField").val("");
    var userslist = [];
    var users = [];

    connect().then(function(res){
      getTable(account.name, "account").then(function(res){
        if(res.rows.length==0) window.location.replace("http://127.0.0.1:5500/index.html");
        $("#userName").text(res.rows[0].userName);
        getTable("slateme55555", "users").then(function(res){
          for(var i = 0;i < res.rows.length;i++) {
            userslist.push(res.rows[i]);
            users.push(res.rows[i].userName);
            signedacc.push(res.rows[i].accName);
          }
        });
        main();
      });
      autocomplete(document.getElementById("searchField"), users);
    });

    function tweet(){
        eos.contract('slateme55555').then(contract => {
          var accName = account.name;
          var msg = $("#tweetMsg").val();
          var timestamp =  Date.now();
          var tohash = accName+timestamp+msg;
          console.log("tohash:",tohash);
          var hash = (Math.abs(tohash.hashCode()));
          var len = Math.ceil(Math.log(hash + 1) / Math.LN10);
          if(len==9){
            hash=Math.floor(hash/1000);
            }
          else{
            hash=Math.floor(hash/10000);
          }
          len = Math.ceil(Math.log(hash + 1) / Math.LN10); 
          console.log(len);
          var tweetId=(timestamp*10000)+hash;
          console.log("tweetid:",tweetId);
          console.log(typeof tweetId);
          if(msg.length>0){
            console.log(tweetId);
          contract.tweet({tweetId:tweetId,accName,msg,timestamp},options).then(function(res){
            console.log('res', res);
            $("#tweetMsg").val("");
            
            main();
          }).catch(function(err){
            console.log('err', err);
          });
        }
        else alert("scribble something");
        });
    }

    function searchUser() {
      var acc = userslist.find(function(x){ return x.userName === $("#searchField").val() });


      var url = 'http://127.0.0.1:5500/profile.html#' + acc.accName;
      window.location.href = url;
    }
    function visitProfile(){
      var url = 'http://127.0.0.1:5500/profile.html#' + account.name;
      window.location.href = url;

    }

    var mainFollowing=[];
    var tweetIds=[];
    
    function main(){
      mainFollowing=[account.name];
      getTable(account.name, "account").then(function(run){
        for(var val = 0;val<run.rows[0].following.length;val++){   
          if(signedacc.includes(run.rows[0].following[val])){
            mainFollowing.push(run.rows[0].following[val]);
          }
        }
        followingTweet(mainFollowing).then(function(){
        });          
      });
    } 

    var dict = [];
    var arr=[];
    var sorted=[];

    async function followingTweet(mainFollowing){
      console.log(mainFollowing);
      sorted=[];
      dict=[];
      arr=[];
      var i;
      var m=mainFollowing.length;
      for( i=0;i<m;i++){
        var run = await getTable(mainFollowing[i], "account")
          for(var j=0;j<run.rows[0].tweetId.length;j++){
          dict.push(run.rows[0].tweetId[j]);
          }
        }
        dict.sort(function(a,b){return a-b});
        tweets(dict);
    }

    
    String.prototype.hashCode = function() {
        var hash = 0, i = 0, len = this.length;
         while ( i < len ) {
              hash  = ((hash << 5) - hash + this.charCodeAt(i++)) << 0;
                            }
          return hash;
    };                  
  </script>
</body>
</html>