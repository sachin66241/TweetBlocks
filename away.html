<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="refresh">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eosjs@16.0.0/lib/eos.min.js"></script>
    <script src="dist/scatter.min.js"></script> 
    <script src="main1.js"></script>
    <link rel="stylesheet" href="away.css">
    <title>Profile</title>   
</head>
<body>
    <button onclick="signOut()">SIGN OUT</button>
    <button id="buttonFollow"></button>
    <button id="buttonFollowers">Followers</button>
    <button id="buttonFollowing">Following</button>    
    <p id="don"></p>
    <h2 id="ron"></h2>
    <p id="mon"></p>
    <p id="jon"></p>
    <p id="zon"></p>
    <p id="den"></p>
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="rplContent">
                
            </div>
        </div>
              
    </div>

    <script>
        // Get the modal
        var modal = document.getElementById('myModal');
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal 
        // btn.onclick = function() {
        //     modal.style.display = "block";
        // }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        if(performance.navigation.type == 0){
            location.reload(true);
        }

        // //////////////////////////////
        var parameters = location.href.split("#")[1];

        connect().then(function(){
            getTable("twitternew12", "users").then(function(res){
                for(var i = 0;i < res.rows.length;i++) {
                userslist.push(res.rows[i]);
            }
            main();
            });
        })

        function follow(){
            eos.contract('twitternew12').then(contract => {

                contract.follow({accName:account.name,following:parameters},options).then(function(res){
                    console.log('res', res);
                    main();
                }).catch(function(err){
                    console.log('err', err);
                });
            });
        }

        function unfollow(){
            eos.contract('twitternew12').then(contract => {

                contract.unfollow({accName:account.name,unfollowing:parameters},options).then(function(res){
                    console.log('res', res);
                    main();
                }).catch(function(err){
                    console.log('err', err);
                });
            });
        }

        function following(){
            var followDiv=document.createElement("div");
            document.getElementById("rplContent").innerHTML="";
                document.getElementById("rplContent").appendChild(followDiv);
                followDiv.innerHTML=accFollowing;
                modal.style.display = "block";
        }

        function followers(){

            var followDiv=document.createElement("div");
            document.getElementById("rplContent").innerHTML="";
                document.getElementById("rplContent").appendChild(followDiv);
                followDiv.innerHTML=accFollowers;
                modal.style.display = "block";
        }
 
        /////////////////////////////////////////////////////////////////////////////////

        function main(){
            var acc = userslist.find(function(x){ return x.accName === account.name });
            var mainAcc=acc.userName;
            getTable(parameters, "account").then(function(bal){
                document.getElementById('buttonFollowers').innerHTML="Followers ("+bal.rows[0].followers.length+")"
                document.getElementById('buttonFollowing').innerHTML="Following ("+bal.rows[0].following.length+")"
                var foll=0;
                accFollowers=[];                
                while(foll<bal.rows[0].followers.length){
                    var acc = userslist.find(function(x){ return x.accName === bal.rows[0].followers[foll] });
                    accFollowers.push(acc.userName.link('http://127.0.0.1:5500/away.html#' + acc.accName));
                    foll++
                }
                
                var follo=0;
                accFollowing=[];                    
                while(follo<bal.rows[0].following.length){
                    var acc = userslist.find(function(x){ return x.accName === bal.rows[0].following[follo] });
                    accFollowing.push(acc.userName.link('http://127.0.0.1:5500/away.html#' + acc.accName));
                    follo++
                }

                if(accFollowers.length>0){
                    document.getElementById('buttonFollowers').setAttribute('onclick','followers()');
                }

                if(accFollowing.length>0){
                    document.getElementById('buttonFollowing').setAttribute('onclick','following()');
                }

                if(bal.rows[0].followers.includes(account.name)){
                    $('#buttonFollow').html("UNFOLLOW")
                    document.getElementById('buttonFollow').setAttribute('onclick','unfollow()');
                } 
                
                else{ 
                    $('#buttonFollow').html("FOLLOW")
                    document.getElementById('buttonFollow').setAttribute('onclick','follow()');
                }
                $("#ron").text(bal.rows[0].userName);
                length=bal.rows[0].tweetId.length;
                var tweetCount=(bal.rows[0].tweetId.length);
                if(tweetCount>0){
                    tweets(bal.rows[0].tweetId);
                }
                else{
                    console.log("No Tweets Yet !!!!");
                }     
            });
        }
</script>
</body>
</html>
